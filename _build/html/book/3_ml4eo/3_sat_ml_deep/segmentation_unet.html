
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; SENSE Training Resources</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'book/3_ml4eo/3_sat_ml_deep/segmentation_unet';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/Sense-logo-4_transpCol-1024x431.png" class="logo__image only-light" alt="SENSE Training Resources - Home"/>
    <script>document.write(`<img src="../../../_static/Sense-logo-4_transpCol-1024x431.png" class="logo__image only-dark" alt="SENSE Training Resources - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Book 1 - Python Software Carpentry</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../1_python_zero2hero/book1_overview.html">0 - Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_python_zero2hero/1_intro.html">1 - Intro to Python</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/1_intro/00-Introduction.html">1.0 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/1_intro/01-How-to-Run-Python-Code.html">1.1 How to Run Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/1_intro/02-Jupyter-Notebook.html">1.2 Jupyter Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/1_intro/03-Basic-Python-Syntax.html">1.3 Python Language Syntax</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics.html">2 - Python Basics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/01-Semantics-Variables.html">2.1 Variables and Objects in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/02-Semantics-Operators.html">2.2 Basic Python Semantics: Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/03-Built-in-Scalar-Types.html">2.3 Built-In Types: Simple Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/04-Built-in-Data-Structures.html">2.4 Built-In Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/05-Ex-Try-Python-Basics.html">Exercise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/06-Control-Flow-Statements.html">2.5 Control Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/07-Defining-Functions.html">2.6 Defining and Using Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/2_python_basics/09-Modules-and-Packages.html">Modules and Packages</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation.html">3 - Plotting</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation/01-Numpy-Intro.html"> Introduction to NumPy</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation/02-Matplotlib.html">Matplotlib - Intro</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation/03-Working-with-datetime.html">Working with dates and times</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation/04-Pandas-Intro.html">Introduction to pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_python_zero2hero/3_data_analysis_visualisation/05-Plotting-with-Seaborn.html">Statistical plotting with Seaborn</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Book 2 - GeoPython</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../2_geo_python/book2_overview.html">0 - Overview</a></li>

<li class="toctree-l1 has-children"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools.html">1 - GeoPython Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/00_intro_to_geospatial_data.html">Introduction to Geospatial Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/cartopy.html">Cartopy</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/geopandas.html">GeoPandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/rasterio.html">Rasterio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/rioxarray.html">Rioxarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/xarray.html">Xarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/1_spatial_data_tools/20-Xarray-NetCDF-Intro.html">Working with NetCDF files</a></li>








</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../2_geo_python/2_eo_data.html">2 - EO data</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../2_geo_python/3_gee_python.html">3 - GEE Python</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/3_gee_python/0_First_steps.html">Linking Google Colab to your GitHub page</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/3_gee_python/1_Open_and_display.html">Google Earth Engine: JavaScript, but Python</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../2_geo_python/3_gee_python/2_Time_series.html">ImageCollection</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Book 3 - Machine Learning for EO</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book3_overview.html">0 - Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2_sat_ml_intro.html">2 - Classical ML with satellite data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../2_sat_ml_intro/1_linear_regression.html">Practical 1: Linear Regression</a></li>





<li class="toctree-l2"><a class="reference internal" href="../2_sat_ml_intro/2_classification.html">Practical 2: Classification</a></li>


<li class="toctree-l2"><a class="reference internal" href="../2_sat_ml_intro/3_kalman_filter.html">Practical 3: Kalman Filter</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3_sat_ml_deep.html">3 - Deep Learning with PyTorch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="00_intro.html">Satellite image deep learning with PyTorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_segmentation_unet.html">Semantic segmentation of Aerial Imaginary with U-Net-like architectures</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4_embeddings.html">4 - Embeddings</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../4_embeddings/notebooks/1a_Use_PCA_analysis_to_study_tile_embeddings.html">Use PCA analysis on tile embeddings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4_embeddings/notebooks/1b_Exploring_embedding_space_with_clustering_methods.html">How are the study tiles clustered in the embedding space?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4_embeddings/notebooks/2_Working_with_your_own_data.html">Working with your own input data</a></li>

</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/leamhowe/sense-jb/blob/main/book/book/3_ml4eo/3_sat_ml_deep/segmentation_unet.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/leamhowe/sense-jb" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/leamhowe/sense-jb/issues/new?title=Issue%20on%20page%20%2Fbook/3_ml4eo/3_sat_ml_deep/segmentation_unet.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/book/3_ml4eo/3_sat_ml_deep/segmentation_unet.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Overview</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloaders">Dataloaders</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualise-batch">Visualise Batch</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-model-u-net-based-model">Define the model: U-Net based model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-model">Segmentation Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">Training Loop</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualise-results">Visualise results</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-and-accuracy-functions">Loss and Accuracy Functions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-finetune-the-segmentation-model">Exercise 1: Finetune the segmentation model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-try-another-model-architecture">Exercise 2: Try another model architecture</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">kornia.augmentation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">K</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">jaccard_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">RasterDataset</span><span class="p">,</span> <span class="n">stack_samples</span><span class="p">,</span> <span class="n">unbind_samples</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.samplers</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomGeoSampler</span><span class="p">,</span> <span class="n">Units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">indices</span>
</pre></div>
</div>
</div>
</div>
<section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Loading a dataset</p></li>
<li><p>Creating a RasterDataset, DataLoaders and Samplers</p></li>
<li><p>Normalising the data</p></li>
<li><p>Spectral indicies</p></li>
<li><p>define a unet model</p></li>
<li><p>loss function and metrics</p></li>
<li><p>training loop</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tmp_path = &#39;~/tmp/surface_water/&#39;</span>
<span class="c1"># utils.download_and_extract_archive(</span>
<span class="c1">#     &#39;https://hf.co/datasets/cordmaur/earth_surface_water/resolve/main/earth_surface_water.zip&#39;,</span>
<span class="c1">#     tmp_path,</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from collections.abc import Callable</span>
<span class="c1"># from pathlib import Path</span>
<span class="c1"># from typing import Optional, Dict</span>

<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># from PIL import Image</span>
<span class="c1"># from torch import Tensor</span>
<span class="c1"># from torchgeo.datasets import NonGeoDataset</span>
<span class="c1"># from torchvision.transforms import ToTensor</span>

<span class="c1"># class CustomNonGeoDataset(NonGeoDataset):</span>
<span class="c1">#     &quot;&quot;&quot;Custom dataset for semantic segmentation of satellite data.</span>

<span class="c1">#     Dataset features:</span>
<span class="c1">#     - Images: RGB satellite images in .jpg format.</span>
<span class="c1">#     - Masks: Grayscale masks in .png format.</span>
<span class="c1">#     - Classes: Binary or multi-class segmentation masks.</span>

<span class="c1">#     Dataset format:</span>
<span class="c1">#     - Images and masks are stored in separate directories (`images` and `mask`).</span>
<span class="c1">#     - Filenames of images and masks match exactly (e.g., `Tile1_00_009.jpg` and `Tile1_00_009.png`).</span>

<span class="c1">#     If you use this dataset in your research, please cite the appropriate source.</span>

<span class="c1">#     .. versionadded:: 0.1</span>
<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         root: str = &quot;data&quot;,</span>
<span class="c1">#         split: str = &quot;train&quot;,</span>
<span class="c1">#         transforms: Optional[Callable[[Dict[str, Tensor]], Dict[str, Tensor]]] = None,</span>
<span class="c1">#         download: bool = False,</span>
<span class="c1">#     ) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;Initialize the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             root: Root directory where dataset is stored.</span>
<span class="c1">#             split: One of &quot;train&quot;, &quot;val&quot;, or &quot;test&quot;.</span>
<span class="c1">#             transforms: A function/transform to apply to the input and target.</span>
<span class="c1">#             download: If True, download the dataset (not implemented in this example).</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         super().__init__()</span>
<span class="c1">#         root = Path(root)</span>
<span class="c1">#         split = split</span>
<span class="c1">#         transforms = transforms</span>

<span class="c1">#         # Define paths for images and masks</span>
<span class="c1">#         image_dir = root / split / &quot;images&quot;</span>
<span class="c1">#         mask_dir = root / split / &quot;mask&quot;</span>

<span class="c1">#         # List all image and mask files</span>
<span class="c1">#         self.image_files = sorted(self.image_dir.glob(&quot;*.jpg&quot;))</span>
<span class="c1">#         self.mask_files = sorted(self.mask_dir.glob(&quot;*.png&quot;))</span>

<span class="c1">#         # Ensure that the number of images and masks match</span>
<span class="c1">#         assert len(self.image_files) == len(self.mask_files), &quot;Number of images and masks must match.&quot;</span>

<span class="c1">#     def __len__(self) -&gt; int:</span>
<span class="c1">#         &quot;&quot;&quot;Return the number of samples in the dataset.&quot;&quot;&quot;</span>
<span class="c1">#         return len(self.image_files)</span>

<span class="c1">#     def __getitem__(self, index: int) -&gt; Dict[str, Tensor]:</span>
<span class="c1">#         &quot;&quot;&quot;Return a single sample (image and mask) from the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             index: Index of the sample to retrieve.</span>

<span class="c1">#         Returns:</span>
<span class="c1">#             A dictionary containing the image and mask as tensors.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # Load image</span>
<span class="c1">#         img_path = self.image_files[index]</span>
<span class="c1">#         img = Image.open(img_path).convert(&quot;RGB&quot;)  # Ensure 3 channels (RGB)</span>

<span class="c1">#         # Load mask</span>
<span class="c1">#         mask_path = self.mask_files[index]</span>
<span class="c1">#         mask = Image.open(mask_path).convert(&quot;L&quot;)  # Ensure grayscale (1 channel)</span>

<span class="c1">#         # Convert to tensors</span>
<span class="c1">#         img_tensor = ToTensor()(img)</span>
<span class="c1">#         mask_tensor = ToTensor()(mask)</span>

<span class="c1">#         # Apply transforms if provided</span>
<span class="c1">#         sample = {&quot;image&quot;: img_tensor, &quot;mask&quot;: mask_tensor}</span>
<span class="c1">#         if self.transforms:</span>
<span class="c1">#             sample = self.transforms(sample)</span>

<span class="c1">#         return sample</span>

<span class="c1">#     def plot(self,  index: int) -&gt; plt.Figure:</span>
<span class="c1">#         &quot;&quot;&quot;Plot a sample from the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             index: Index of the sample to plot.</span>

<span class="c1">#         Returns:</span>
<span class="c1">#             A matplotlib figure showing the image and mask.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         sample = self[index]</span>
<span class="c1">#         img = sample[&quot;image&quot;].permute(1, 2, 0).numpy()  # Convert to HWC format</span>
<span class="c1">#         mask = sample[&quot;mask&quot;].squeeze().numpy()  # Remove channel dimension</span>

<span class="c1">#         fig, ax = plt.subplots(1, 2, figsize=(10, 5))</span>
<span class="c1">#         ax[0].imshow(img)</span>
<span class="c1">#         ax[0].set_title(&quot;Image&quot;)</span>
<span class="c1">#         ax[1].imshow(mask, </span>
<span class="c1">#                      #cmap=cmap</span>
<span class="c1">#                      )</span>
<span class="c1">#         ax[1].set_title(&quot;Mask&quot;)</span>
<span class="c1">#         plt.tight_layout()</span>

<span class="c1">#         return fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from collections.abc import Callable</span>
<span class="c1"># from pathlib import Path</span>
<span class="c1"># from typing import Optional, Dict</span>

<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># from PIL import Image</span>
<span class="c1"># from torch import Tensor</span>
<span class="c1"># from torchgeo.datasets import NonGeoDataset</span>
<span class="c1"># from torchvision.transforms import ToTensor</span>

<span class="c1"># class CustomNonGeoDataset(NonGeoDataset):</span>
<span class="c1">#     &quot;&quot;&quot;Custom dataset for semantic segmentation of satellite data.</span>

<span class="c1">#     Dataset features:</span>
<span class="c1">#     - Images: RGB satellite images in .jpg format.</span>
<span class="c1">#     - Masks: Grayscale masks in .png format.</span>
<span class="c1">#     - Classes: Binary or multi-class segmentation masks.</span>

<span class="c1">#     Dataset format:</span>
<span class="c1">#     - Images and masks are stored in separate directories (`images` and `mask`).</span>
<span class="c1">#     - Filenames of images and masks match exactly (e.g., `Tile1_00_009.jpg` and `Tile1_00_009.png`).</span>

<span class="c1">#     If you use this dataset in your research, please cite the appropriate source.</span>

<span class="c1">#     .. versionadded:: 0.1</span>
<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         root: str = &quot;data&quot;,</span>
<span class="c1">#         split: str = &quot;train&quot;,</span>
<span class="c1">#         transforms: Optional[Callable[[Dict[str, Tensor]], Dict[str, Tensor]]] = None,</span>
<span class="c1">#         download: bool = False,</span>
<span class="c1">#     ) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;Initialize the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             root: Root directory where dataset is stored.</span>
<span class="c1">#             split: One of &quot;train&quot;, &quot;val&quot;, or &quot;test&quot;.</span>
<span class="c1">#             transforms: A function/transform to apply to the input and target.</span>
<span class="c1">#             download: If True, download the dataset (not implemented in this example).</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         super().__init__()</span>
<span class="c1">#         self.root = Path(root)</span>
<span class="c1">#         self.split = split</span>
<span class="c1">#         self.transforms = transforms</span>

<span class="c1">#         # Define paths for images and masks</span>
<span class="c1">#         self.image_dir = self.root / split / &quot;images&quot;</span>
<span class="c1">#         self.mask_dir = self.root / split / &quot;mask&quot;</span>

<span class="c1">#         # List all image and mask files</span>
<span class="c1">#         self.image_files = sorted(self.image_dir.glob(&quot;*.jpg&quot;))</span>
<span class="c1">#         self.mask_files = sorted(self.mask_dir.glob(&quot;*.png&quot;))</span>

<span class="c1">#         # Ensure that the number of images and masks match</span>
<span class="c1">#         assert len(self.image_files) == len(self.mask_files), &quot;Number of images and masks must match.&quot;</span>

<span class="c1">#     def __len__(self) -&gt; int:</span>
<span class="c1">#         &quot;&quot;&quot;Return the number of samples in the dataset.&quot;&quot;&quot;</span>
<span class="c1">#         return len(self.image_files)</span>

<span class="c1">#     def __getitem__(self, index: int) -&gt; Dict[str, Tensor]:</span>
<span class="c1">#         &quot;&quot;&quot;Return a single sample (image and mask) from the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             index: Index of the sample to retrieve.</span>

<span class="c1">#         Returns:</span>
<span class="c1">#             A dictionary containing the image and mask as tensors.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # Load image</span>
<span class="c1">#         img_path = self.image_files[index]</span>
<span class="c1">#         img = Image.open(img_path).convert(&quot;RGB&quot;)  # Ensure 3 channels (RGB)</span>

<span class="c1">#         # Load mask</span>
<span class="c1">#         # mask_path = self.mask_files[index]</span>
<span class="c1">#         # mask = Image.open(mask_path).convert(&quot;L&quot;)  # Ensure grayscale (1 channel)</span>
<span class="c1">#         # Load lables</span>
<span class="c1">#         labels_path = self.root / &#39;labels.npy&#39;</span>
<span class="c1">#         dict_load=np.load(labels_path, allow_pickle=True)        </span>
<span class="c1">#         if self.split == &#39;train&#39;:</span>
<span class="c1">#             labels = dict_load.item()[&#39;labels_train&#39;]</span>
<span class="c1">#         elif self.split == &#39;val&#39;:</span>
<span class="c1">#             labels = dict_load.item()[&#39;labels_valid&#39;]</span>
<span class="c1">#         elif self.split == &#39;test&#39;:</span>
<span class="c1">#             labels = dict_load.item()[&#39;labels_test&#39;]</span>
        
        

<span class="c1">#         # Convert to tensors</span>
<span class="c1">#         img_tensor = ToTensor()(img)</span>
<span class="c1">#         # mask_tensor = ToTensor()(mask)</span>
<span class="c1">#         labels_tensor = ToTensor()(labels.squeeze()[index])</span>

<span class="c1">#         # Apply transforms if provided</span>
<span class="c1">#         # sample = {&quot;image&quot;: img_tensor, &quot;mask&quot;: mask_tensor}</span>
<span class="c1">#         sample = {&quot;image&quot;: img_tensor, &quot;mask&quot;: labels_tensor}</span>
<span class="c1">#         if self.transforms:</span>
<span class="c1">#             sample = self.transforms(sample)</span>

<span class="c1">#         return sample</span>

<span class="c1">#     def plot(self,  index: int) -&gt; plt.Figure:</span>
<span class="c1">#         &quot;&quot;&quot;Plot a sample from the dataset.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             index: Index of the sample to plot.</span>

<span class="c1">#         Returns:</span>
<span class="c1">#             A matplotlib figure showing the image and mask.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         sample = self[index]</span>
<span class="c1">#         img = sample[&quot;image&quot;].permute(1, 2, 0).numpy()  # Convert to HWC format</span>
<span class="c1">#         mask = sample[&quot;mask&quot;].squeeze().numpy()  # Remove channel dimension</span>

<span class="c1">#         fig, ax = plt.subplots(1, 2, figsize=(10, 5))</span>
<span class="c1">#         ax[0].imshow(img)</span>
<span class="c1">#         ax[0].set_title(&quot;Image&quot;)</span>
<span class="c1">#         ax[1].imshow(mask, </span>
<span class="c1">#                     #  cmap=cmap</span>
<span class="c1">#                      )</span>
<span class="c1">#         ax[1].set_title(&quot;Mask&quot;)</span>
<span class="c1">#         plt.tight_layout()</span>

<span class="c1">#         return fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">NonGeoDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToTensor</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomNonGeoDataset</span><span class="p">(</span><span class="n">NonGeoDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom dataset for semantic segmentation of satellite data.</span>

<span class="sd">    Dataset features:</span>
<span class="sd">    - Images: RGB satellite images in .jpg format.</span>
<span class="sd">    - Masks: Grayscale masks in .png format.</span>
<span class="sd">    - Classes: Binary or multi-class segmentation masks.</span>

<span class="sd">    Dataset format:</span>
<span class="sd">    - Images and masks are stored in separate directories (`images` and `mask`).</span>
<span class="sd">    - Filenames of images and masks match exactly (e.g., `Tile1_00_009.jpg` and `Tile1_00_009.png`).</span>

<span class="sd">    If you use this dataset in your research, please cite the appropriate source.</span>

<span class="sd">    .. versionadded:: 0.1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            root: Root directory where dataset is stored.</span>
<span class="sd">            split: One of &quot;train&quot;, &quot;val&quot;, or &quot;test&quot;.</span>
<span class="sd">            transforms: A function/transform to apply to the input and target.</span>
<span class="sd">            download: If True, download the dataset (not implemented in this example).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">=</span> <span class="n">split</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>

        <span class="c1"># Define paths for images and masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">split</span> <span class="o">/</span> <span class="s2">&quot;images&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">split</span> <span class="o">/</span> <span class="s2">&quot;mask&quot;</span>

        <span class="c1"># List all image and mask files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.jpg&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.png&quot;</span><span class="p">))</span>

        <span class="c1"># Load labels from .npy file</span>
        <span class="n">labels_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="s1">&#39;labels.npy&#39;</span>
        <span class="k">if</span> <span class="n">labels_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_load</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels_train&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_load</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels_valid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_load</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels_test&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labels for split &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="n">labels_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labels file not found: </span><span class="si">{</span><span class="n">labels_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ensure that the number of images and masks match</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_files</span><span class="p">),</span> <span class="s2">&quot;Number of images and masks must match.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of samples in the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a single sample (image and mask) from the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: Index of the sample to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary containing the image and mask as tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load image</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>  <span class="c1"># Ensure 3 channels (RGB)</span>

        <span class="c1"># Load mask</span>
        <span class="c1"># mask_path = self.mask_files[index]</span>
        <span class="c1"># mask = Image.open(mask_path).convert(&quot;L&quot;)  # Ensure grayscale (1 channel)</span>
        <span class="c1"># Load lables</span>
        <span class="c1"># labels_path = self.root / &#39;labels.npy&#39;</span>
        <span class="c1"># dict_load=np.load(labels_path, allow_pickle=True)        </span>
        <span class="c1"># if self.split == &#39;train&#39;:</span>
        <span class="c1">#     labels = dict_load.item()[&#39;labels_train&#39;]</span>
        <span class="c1"># elif self.split == &#39;val&#39;:</span>
        <span class="c1">#     labels = dict_load.item()[&#39;labels_valid&#39;]</span>
        <span class="c1"># elif self.split == &#39;test&#39;:</span>
        <span class="c1">#     labels = dict_load.item()[&#39;labels_test&#39;]</span>
        
        

        <span class="c1"># Convert to tensors</span>
        <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
        <span class="c1"># print(f&quot;image tensor shape: {img_tensor.shape}&quot;)  # Debug print</span>
        
        <span class="c1"># mask_tensor = ToTensor()(mask)</span>
        <span class="c1"># print(f&quot;Labels: {self.labels}&quot;)  # Debug print</span>
        <span class="c1"># print(f&quot;Labels: {self.labels.shape}&quot;)  # Debug print</span>
        <span class="n">labels_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="c1"># Convert to long tensor (e.g. float32 -&gt; int64)</span>
        <span class="c1"># print(f&quot;Labels tensor shape: {labels_tensor.shape}&quot;)</span>

        <span class="c1"># Apply transforms if provided</span>
        <span class="c1"># sample = {&quot;image&quot;: img_tensor, &quot;mask&quot;: mask_tensor}</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">img_tensor</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">labels_tensor</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a sample from the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: Index of the sample to plot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A matplotlib figure showing the image and mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># Convert to HWC format</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># Remove channel dimension</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> 
                     <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                     <span class="n">vmax</span><span class="o">=</span><span class="mi">6</span>
                    <span class="c1">#  cmap=cmap</span>
                     <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mask&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomNonGeoDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;./dubai_segmentation&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

<span class="c1"># Access a sample</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># Should print torch.Size([3, H, W]) and torch.Size([1, H, W])</span>

<span class="c1"># Plot a sample</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Create a DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([3, 256, 256]) torch.Size([256, 256])
</pre></div>
</div>
<img alt="../../../_images/6aacf66f9653c081a0f6dd8c09891b45895b92345c05e9dadbe851ef679ec7ad.png" src="../../../_images/6aacf66f9653c081a0f6dd8c09891b45895b92345c05e9dadbe851ef679ec7ad.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span>
    <span class="k">return</span> <span class="n">item</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dataloaders">
<h1>Dataloaders<a class="headerlink" href="#dataloaders" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">ToTensor</span><span class="p">,</span> <span class="n">Resize</span>

<span class="c1"># Define transforms (optional)</span>
<span class="c1"># For example, resize images and masks to 512x512 and convert them to tensors</span>
<span class="n">transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span>
    <span class="c1"># Resize((512, 512)),  # Resize images and masks to 512x512</span>
    <span class="c1"># ToTensor(),           # Convert images and masks to PyTorch tensors</span>
<span class="p">])</span>

<span class="c1"># Create datasets</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomNonGeoDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;./dubai_segmentation&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">CustomNonGeoDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;./dubai_segmentation&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomNonGeoDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;./dubai_segmentation&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>

<span class="c1"># Define batch size</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Adjust as needed</span>

<span class="c1"># Create DataLoaders</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Shuffle the training data</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># Number of subprocesses for data loading</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Speed up data transfer to GPU</span>
<span class="p">)</span>

<span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Do not shuffle validation data</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># Number of subprocesses for data loading</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Speed up data transfer to GPU</span>
<span class="p">)</span>

<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Do not shuffle test data</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># Number of subprocesses for data loading</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Speed up data transfer to GPU</span>
<span class="p">)</span>


<span class="c1"># Print details</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training DataLoader: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches of size </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation DataLoader: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches of size </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test DataLoader: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches of size </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training DataLoader: 98 batches of size 8
Validation DataLoader: 33 batches of size 8
Test DataLoader: 33 batches of size 8
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualise-batch">
<h1>Visualise Batch<a class="headerlink" href="#visualise-batch" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span> <span class="k">as</span> <span class="n">mcolors</span>

<span class="c1"># Define the colormap</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Building&#39;</span><span class="p">,</span> <span class="s1">&#39;Road&#39;</span><span class="p">,</span> <span class="s1">&#39;Land&#39;</span><span class="p">,</span> <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span> <span class="s1">&#39;Water&#39;</span><span class="p">,</span> <span class="s1">&#39;Unlabeled&#39;</span><span class="p">]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span>
    <span class="s1">&#39;#3C1098&#39;</span><span class="p">,</span>  <span class="c1"># Building</span>
    <span class="s1">&#39;#8429F6&#39;</span><span class="p">,</span>  <span class="c1"># Road</span>
    <span class="s1">&#39;#6EC1E4&#39;</span><span class="p">,</span>  <span class="c1"># Land (unpaved area)</span>
    <span class="s1">&#39;#FEDD3A&#39;</span><span class="p">,</span>  <span class="c1"># Vegetation</span>
    <span class="s1">&#39;#E2A929&#39;</span><span class="p">,</span>  <span class="c1"># Water</span>
    <span class="s1">&#39;#9B9B9B&#39;</span>   <span class="c1"># Unlabeled</span>
<span class="p">])</span>

<span class="c1"># Function to visualize a specific batch of images and masks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_batch</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize a specific batch of images and masks from a dataloader.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataloader (DataLoader): The dataloader containing the dataset.</span>
<span class="sd">        batch_idx (int): The index of the batch to visualize.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Iterate through the dataloader to the specified batch</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">batch_idx</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch index </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2"> is out of range for the dataloader.&quot;</span><span class="p">)</span>

    <span class="c1"># Plot the images and masks</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">to_pil_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                          <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                          <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span>
                          <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mask&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="c1"># Add legend</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">))]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visualize_batch</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/a5fbae899310cad18e528446980f2fb972db3ba1efc560427fbadcbab26fd656.png" src="../../../_images/a5fbae899310cad18e528446980f2fb972db3ba1efc560427fbadcbab26fd656.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visualize_batch</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3783774c0134f902d78be1f77514390be0c02ff6a5a48d6a7fd039c540526972.png" src="../../../_images/3783774c0134f902d78be1f77514390be0c02ff6a5a48d6a7fd039c540526972.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import matplotlib.colors as mcolors</span>
<span class="c1"># import matplotlib.pyplot as plt</span>

<span class="c1"># # Define the colormap</span>
<span class="c1"># cmap = mcolors.ListedColormap([</span>
<span class="c1">#     &#39;#3C1098&#39;,  # Building</span>
<span class="c1">#     &#39;#8429F6&#39;,  # Land (unpaved area)</span>
<span class="c1">#     &#39;#6EC1E4&#39;,  # Road</span>
<span class="c1">#     &#39;#FEDD3A&#39;,  # Vegetation</span>
<span class="c1">#     &#39;#E2A929&#39;,  # Water</span>
<span class="c1">#     &#39;#9B9B9B&#39;   # Unlabeled</span>
<span class="c1"># ])</span>

<span class="c1"># # Create a colorbar legend</span>
<span class="c1"># norm = mcolors.BoundaryNorm(boundaries=[0, 1, 2, 3, 4, 5, 6], ncolors=cmap.N)</span>
<span class="c1"># sm = plt.cm.ScalarMappable(cmap=cmap, norm=norm)</span>
<span class="c1"># sm.set_array([])  # Set an empty array to avoid error</span>
<span class="c1"># cbar = plt.colorbar(sm, ticks=[0.5, 1.5, 2.5, 3.5, 4.5, 5.5])</span>
<span class="c1"># cbar.set_ticklabels([&#39;Building&#39;, &#39;Land&#39;, &#39;Road&#39;, &#39;Vegetation&#39;, &#39;Water&#39;, &#39;Unlabeled&#39;])</span>
<span class="c1"># cbar.set_label(&#39;Class&#39;)</span>

<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
<section id="define-the-model-u-net-based-model">
<h2>Define the model: U-Net based model<a class="headerlink" href="#define-the-model-u-net-based-model" title="Link to this heading">#</a></h2>
<p>The model we defined consists of a contracting path and an expansive path.</p>
<ul class="simple">
<li><p>The contracting path follows the typical architecture of a convolutional network. It consists of the repeated application of two 3x3 convolutions, each followed by a rectified linear unit (ReLU) and a 2x2 max pooling operation with stride 2 for downsampling.</p></li>
<li><p>At each downsampling step we double the number of feature channels. Every step in the expansive path consists of an upsampling of the feature map followed by a 2x2 convolution (“up-convolution”) that halves the number of feature channels, a concatenation with the correspondingly cropped feature map from the contracting path, and two 3x3 convolutions, each followed by a ReLU.</p></li>
</ul>
<p>At the final layer, a 1x1 convolution is used to map each 64-component feature vector to the desired number of classes.</p>
<p>Layers used:</p>
<ol class="arabic simple">
<li><p><strong>Conv2D</strong></p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span> <span class="n">bias_initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bias_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">activity_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kernel_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bias_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>MaxPooling2D</strong></p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>UpSampling2D</strong></p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>interpolation:	A string, one of ‘nearest’ or ‘bilinear’.</p></li>
</ul>
</section>
</section>
<section id="segmentation-model">
<h1>Segmentation Model<a class="headerlink" href="#segmentation-model" title="Link to this heading">#</a></h1>
<p>For the semantic segmentation model, we are going to use a predefined architecture that is available in Pytorch. Looking at list (<a class="reference external" href="https://pytorch.org/vision/stable/models.html#semantic-segmentation">https://pytorch.org/vision/stable/models.html#semantic-segmentation</a>) it is possible to note 3 models available for semantic segmentation, but one (LRASPP) is intended for mobile applications. In our tutorial, we will use the DeepLabV3 model.</p>
<p>Here, we will create a DeepLabV3 model for 2 classes. In this case, I will skip the pretrained weights, as the weights represent another domain (not water segmentation from multispectral imagery).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from torchvision.models.segmentation import deeplabv3_resnet50</span>

<span class="c1"># model = deeplabv3_resnet50(weights=None, num_classes=6)</span>
<span class="c1"># model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import pytorch_lightning as pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.trainers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SemanticSegmentationTask</span>

<span class="c1"># Define the task</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">SemanticSegmentationTask</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;ce&#39;</span><span class="p">,</span>  <span class="c1"># Cross-entropy loss</span>
    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;unet&#39;</span><span class="p">,</span>  <span class="c1"># U-Net model</span>
    <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Input channels (e.g., RGB images)</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># Number of output classes</span>
    <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># Learning rate</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Patience for early stopping</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The first thing we have to pay attention in the model architecture is the number of channels expected in the first convolution (Conv2d), that is defined as 3. That’s because the model is prepared to work with RGB images. After the first convolution, the 3 channels will produce 64 channels in lower resolution, and so on. As we have now 9 channels, we will change this first processing layer to adapt correctly to our model. We can do this by replacing the first convolutional layer for a new one, by following the commands. Finally, we check a mock batch can pass through the model and provide the output with 2 channels (water / no_water) as desired.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># backbone = model.get_submodule(&#39;backbone&#39;)</span>

<span class="c1"># conv = torch.nn.modules.conv.Conv2d(</span>
<span class="c1">#     in_channels=3,</span>
<span class="c1">#     out_channels=64,</span>
<span class="c1">#     kernel_size=(7, 7),</span>
<span class="c1">#     stride=(2, 2),</span>
<span class="c1">#     padding=(3, 3),</span>
<span class="c1">#     bias=False,</span>
<span class="c1"># )</span>
<span class="c1"># backbone.register_module(&#39;conv1&#39;, conv)</span>

<span class="c1"># pred = model(torch.randn(3, 9, 512, 512))</span>
<span class="c1"># pred[&#39;out&#39;].shape</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-loop">
<h1>Training Loop<a class="headerlink" href="#training-loop" title="Link to this heading">#</a></h1>
<p>The training function should receive the number of epochs, the model, the dataloaders, the loss function (to be optimized) the accuracy function (to assess the results), the optimizer (that will adjust the parameters of the model in the correct direction) and the transformations to be applied to each batch.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">load_ext</span> tensorboard

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorBoardLogger</span>

<span class="c1"># from torchgeo.datamodules import EuroSAT100DataModule</span>
<span class="c1"># from torchgeo.models import ResNet18_Weights</span>
<span class="c1"># from torchgeo.trainers import ClassificationTask</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if GPU is available</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="n">device</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>device(type=&#39;cuda&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">fast_dev_run</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">accelerator</span> <span class="o">=</span> <span class="s1">&#39;gpu&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">default_root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="s1">&#39;experiments&#39;</span><span class="p">)</span>
<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="n">default_root_dir</span><span class="p">,</span> <span class="n">save_top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">early_stopping_callback</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">default_root_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tutorial_logs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Log loss and accuracy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train_loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train_acc&#39;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">accelerator</span><span class="o">=</span><span class="n">accelerator</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">,</span> <span class="n">early_stopping_callback</span><span class="p">,</span> <span class="p">],</span>
    <span class="c1"># fast_dev_run=fast_dev_run,</span>
    <span class="n">log_every_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="n">min_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>
    <span class="c1"># enable_checkpointing=True,</span>
    <span class="c1"># enable_early_stopping=True,</span>
    <span class="c1"># check_val_every_n_epoch=1</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/exports/csce/datastore/geos/users/s2112771/miniforge3/envs/sensebook/lib/python3.12/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /exports/csce/datastore/geos/users/s2112771/miniforg ...
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># history = </span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">train_dataloaders</span><span class="o">=</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloaders</span><span class="o">=</span><span class="n">val_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/exports/csce/datastore/geos/users/s2112771/miniforge3/envs/sensebook/lib/python3.12/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:654: Checkpoint directory /exports/csce/datastore/geos/users/s2112771/sense_cpd/sense_book/book/3_ml4eo/3_sat_ml_deep/experiments exists and is not empty.
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: 
  | Name          | Type             | Params | Mode 
-----------------------------------------------------------
0 | model         | Unet             | 32.5 M | train
1 | criterion     | CrossEntropyLoss | 0      | train
2 | train_metrics | MetricCollection | 0      | train
3 | val_metrics   | MetricCollection | 0      | train
4 | test_metrics  | MetricCollection | 0      | train
-----------------------------------------------------------
32.5 M    Trainable params
0         Non-trainable params
32.5 M    Total params
130.087   Total estimated model params size (MB)
233       Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name          | Type             | Params | Mode 
-----------------------------------------------------------
0 | model         | Unet             | 32.5 M | train
1 | criterion     | CrossEntropyLoss | 0      | train
2 | train_metrics | MetricCollection | 0      | train
3 | val_metrics   | MetricCollection | 0      | train
4 | test_metrics  | MetricCollection | 0      | train
-----------------------------------------------------------
32.5 M    Trainable params
0         Non-trainable params
32.5 M    Total params
130.087   Total estimated model params size (MB)
233       Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 38: 100%|██████████| 98/98 [00:11&lt;00:00,  8.57it/s, v_num=2]         
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># test_dataset = CustomNonGeoDataset(root=&quot;./dubai_segmentation&quot;, split=&quot;test&quot;, transforms=transforms)</span>
<span class="c1"># test_dataloader = DataLoader(</span>
<span class="c1">#     test_dataset,</span>
<span class="c1">#     batch_size=batch_size,</span>
<span class="c1">#     shuffle=False,  # Do not shuffle test data</span>
<span class="c1">#     num_workers=num_workers,  # Number of subprocesses for data loading</span>
<span class="c1">#     pin_memory=True,  # Speed up data transfer to GPU</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">dataloaders</span><span class="o">=</span><span class="n">test_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Testing DataLoader 0: 100%|██████████| 33/33 [00:00&lt;00:00, 47.59it/s]
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
  test_MulticlassAccuracy      0.8341513276100159
test_MulticlassJaccardIndex    0.7154885530471802
         test_loss             0.4819890260696411
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;test_loss&#39;: 0.4819890260696411,
  &#39;test_MulticlassAccuracy&#39;: 0.8341513276100159,
  &#39;test_MulticlassJaccardIndex&#39;: 0.7154885530471802}]
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualise-results">
<h1>Visualise results<a class="headerlink" href="#visualise-results" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the model from the checkpoint</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">SemanticSegmentationTask</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="s1">&#39;./experiments/last-v2.ckpt&#39;</span><span class="p">,</span> <span class="p">)</span>
<span class="n">task</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">task</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Disable dropout and batch normalization</span>
<span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>  <span class="c1"># Freeze the model for inference</span>

<span class="c1"># Initialize lists to store predictions and ground truth masks</span>
<span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_masks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="c1"># Get a batch of test data</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">))</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
    
    <span class="c1"># Make predictions</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">task</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="c1"># Convert predictions to masks</span>
    <span class="n">predicted_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Store predictions and ground truth masks</span>
    <span class="n">all_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># Move predictions to CPU</span>
    <span class="n">all_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># Move masks to CPU</span>

<span class="c1"># Concatenate predictions and ground truth masks</span>
<span class="n">all_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_preds</span><span class="p">)</span>
<span class="n">all_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_masks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to visualize a batch of images and masks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_batch</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">predicted_masks</span><span class="p">):</span>
    <span class="c1"># Get a batch of training data</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    
    <span class="c1"># Plot the images and masks</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">to_pil_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">predicted_mask</span> <span class="o">=</span> <span class="n">predicted_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mask&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">predicted_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Mask&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    
        <span class="c1"># Add legend</span>
        <span class="c1"># legend_labels = [&#39;Building&#39;, &#39;Land&#39;, &#39;Road&#39;, &#39;Vegetation&#39;, &#39;Water&#39;, &#39;Unlabeled&#39;]</span>
        <span class="c1"># legend_labels = [&#39;Water&#39;, &#39;Land (unpaved area)&#39;, &#39;Road&#39;, &#39;Building&#39;, &#39;Vegetation&#39;, &#39;Unlabelled&#39;]</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">))]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">class_names</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torchmetrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfusionMatrix</span>

<span class="c1"># Define the number of classes</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Adjust based on your dataset</span>

<span class="c1"># Initialize the confusion matrix</span>
<span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">ConfusionMatrix</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>

<span class="c1"># Compute the confusion matrix</span>
<span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">all_masks</span><span class="p">)</span>
<span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a confusion matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        conf_matrix (torch.Tensor or numpy.ndarray): Confusion matrix.</span>
<span class="sd">        class_names (list): List of class names.</span>
<span class="sd">        normalize (bool): Whether to normalize the confusion matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">xticklabels</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">class_names</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Normalized Confusion Matrix&#39;</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the normalized confusion matrix</span>
<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;pink_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/abe8fd0e17834f0b4712e1b859cc83e6c883351ab36306881bbb0fa363067db3.png" src="../../../_images/abe8fd0e17834f0b4712e1b859cc83e6c883351ab36306881bbb0fa363067db3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the normalized confusion matrix</span>
<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;pink_r&#39;</span><span class="p">)</span>
<span class="c1"># plot_confusion_matrix(conf_matrix, class_names, normalize=True, cmap=&#39;bone_r&#39;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/520195cf3aca9bb1ea751c8c92a72b978ccb8b6207409ffa092765b07155cbc0.png" src="../../../_images/520195cf3aca9bb1ea751c8c92a72b978ccb8b6207409ffa092765b07155cbc0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Define the colormap</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span>
    <span class="s1">&#39;#3C1098&#39;</span><span class="p">,</span>  <span class="c1"># Building</span>
    <span class="s1">&#39;#8429F6&#39;</span><span class="p">,</span>  <span class="c1"># Land (unpaved area)</span>
    <span class="s1">&#39;#6EC1E4&#39;</span><span class="p">,</span>  <span class="c1"># Road</span>
    <span class="s1">&#39;#FEDD3A&#39;</span><span class="p">,</span>  <span class="c1"># Vegetation</span>
    <span class="s1">&#39;#E2A929&#39;</span><span class="p">,</span>  <span class="c1"># Water</span>
    <span class="s1">&#39;#9B9B9B&#39;</span>   <span class="c1"># Unlabeled</span>
<span class="p">])</span>

<span class="c1"># Define the labels for each color</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Building&#39;</span><span class="p">,</span> <span class="s1">&#39;Land (unpaved area)&#39;</span><span class="p">,</span> <span class="s1">&#39;Road&#39;</span><span class="p">,</span> <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span> <span class="s1">&#39;Water&#39;</span><span class="p">,</span> <span class="s1">&#39;Unlabeled&#39;</span><span class="p">]</span>

<span class="c1"># Create a figure and axis</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Create a colorbar</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Define boundaries for each color</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span>
                  <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">bounds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># Set the labels for the colorbar</span>

<span class="c1"># Display the colorbar</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/0180286393932e8ae9c25710be6c07bdd1854ae5edc6baa6bcdbe19c25fe2769.png" src="../../../_images/0180286393932e8ae9c25710be6c07bdd1854ae5edc6baa6bcdbe19c25fe2769.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def train_loop(</span>
<span class="c1">#     epochs: int,</span>
<span class="c1">#     train_dl: DataLoader,</span>
<span class="c1">#     val_dl: DataLoader | None,</span>
<span class="c1">#     model: torch.nn.Module,</span>
<span class="c1">#     loss_fn: Callable,</span>
<span class="c1">#     optimizer: torch.optim.Optimizer,</span>
<span class="c1">#     acc_fns: list | None = None,</span>
<span class="c1">#     batch_tfms: Callable | None = None,</span>
<span class="c1">#     ):</span>
<span class="c1">#     # size = len(dataloader.dataset)</span>
<span class="c1">#     cuda_model = model.to(device)</span>

<span class="c1">#     for epoch in range(epochs):</span>
<span class="c1">#         accum_loss = 0</span>
<span class="c1">#         for batch in train_dl:</span>
<span class="c1">#             if batch_tfms is not None:</span>
<span class="c1">#                 X = batch_tfms(batch[&#39;image&#39;]).to(device)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 X = batch[&#39;image&#39;].to(device)</span>

<span class="c1">#             y = batch[&#39;mask&#39;].type(torch.long).to(device)</span>
<span class="c1">#             pred = cuda_model(X)[&#39;out&#39;]</span>
<span class="c1">#             loss = loss_fn(pred, y)</span>

<span class="c1">#             # BackProp</span>
<span class="c1">#             optimizer.zero_grad()</span>
<span class="c1">#             loss.backward()</span>
<span class="c1">#             optimizer.step()</span>

<span class="c1">#             # update the accum loss</span>
<span class="c1">#             accum_loss += float(loss) / len(train_dl)</span>

<span class="c1">#         # Testing against the validation dataset</span>
<span class="c1">#         if acc_fns is not None and val_dl is not None:</span>
<span class="c1">#             # reset the accuracies metrics</span>
<span class="c1">#             acc = [0.0] * len(acc_fns)</span>

<span class="c1">#             with torch.no_grad():</span>
<span class="c1">#                 for batch in val_dl:</span>
<span class="c1">#                     if batch_tfms is not None:</span>
<span class="c1">#                         X = batch_tfms(batch[&#39;image&#39;]).to(device)</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         X = batch[&#39;image&#39;].type(torch.float32).to(device)</span>

<span class="c1">#                     y = batch[&#39;mask&#39;].type(torch.long).to(device)</span>

<span class="c1">#                     pred = cuda_model(X)[&#39;out&#39;]</span>

<span class="c1">#                     for i, acc_fn in enumerate(acc_fns):</span>
<span class="c1">#                         acc[i] = float(acc[i] + acc_fn(pred, y) / len(val_dl))</span>

<span class="c1">#             # at the end of the epoch, print the errors, etc.</span>
<span class="c1">#             print(</span>
<span class="c1">#                 f&#39;Epoch {epoch}: Train Loss={accum_loss:.5f} - Accs={[round(a, 3) for a in acc]}&#39;</span>
<span class="c1">#             )</span>
<span class="c1">#         else:</span>
<span class="c1">#             print(f&#39;Epoch {epoch}: Train Loss={accum_loss:.5f}&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loss-and-accuracy-functions">
<h1>Loss and Accuracy Functions<a class="headerlink" href="#loss-and-accuracy-functions" title="Link to this heading">#</a></h1>
<p>For the loss function, normally the Cross Entropy Loss should work, but it requires the mask to have shape (N, d1, d2). In this case, we will need to squeeze our second dimension manually.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def oa(pred, y):</span>
<span class="c1">#     flat_y = y.squeeze()</span>
<span class="c1">#     flat_pred = pred.argmax(dim=1)</span>
<span class="c1">#     acc = torch.count_nonzero(flat_y == flat_pred) / torch.numel(flat_y)</span>
<span class="c1">#     return acc</span>

<span class="c1"># def iou(pred, y):</span>
<span class="c1">#     flat_y = y.cpu().numpy().squeeze()</span>
<span class="c1">#     flat_pred = pred.argmax(dim=1).detach().cpu().numpy()</span>
<span class="c1">#     return jaccard_score(flat_y.reshape(-1), flat_pred.reshape(-1), average=&#39;macro&#39;, zero_division=1.0)</span>

<span class="c1"># def loss(p, t):</span>
<span class="c1">#     return torch.nn.functional.cross_entropy(p, t.squeeze())</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training">
<h1>Training<a class="headerlink" href="#training" title="Link to this heading">#</a></h1>
<blockquote>
<div><p>To train the model it is important to have CUDA GPUs available. In Colab, it can be done by changing the runtime type and re-running the notebook.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # adjust number of epochs depending on the device</span>
<span class="c1"># if torch.cuda.is_available():</span>
<span class="c1">#     num_epochs = 2</span>
<span class="c1"># else:</span>
<span class="c1">#     # if GPU is not available, just make 1 pass and limit the size of the datasets</span>
<span class="c1">#     num_epochs = 1</span>

<span class="c1">#     # by limiting the length of the sampler we limit the iterations in each epoch</span>
<span class="c1">#     train_dataloader.sampler.length = 8</span>
<span class="c1">#     val_dataloader.sampler.length = 8</span>

<span class="c1"># # train the model</span>
<span class="c1"># optimizer = torch.optim.Adam(model.parameters(), lr=0.0001, weight_decay=0.01)</span>
<span class="c1"># train_loop(</span>
<span class="c1">#     num_epochs,</span>
<span class="c1">#     train_dataloader,</span>
<span class="c1">#     val_dataloader,</span>
<span class="c1">#     model,</span>
<span class="c1">#     loss,</span>
<span class="c1">#     optimizer,</span>
<span class="c1">#     acc_fns=[oa, iou],</span>
<span class="c1">#     # batch_tfms=tfms,</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercises">
<h1>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h1>
<section id="exercise-1-finetune-the-segmentation-model">
<h2>Exercise 1: Finetune the segmentation model<a class="headerlink" href="#exercise-1-finetune-the-segmentation-model" title="Link to this heading">#</a></h2>
<p>Now try adjusting the model by implementing different methods of reducing overfitting and increasing the model’s ability to generalise.</p>
<ol class="arabic simple">
<li><p>Retrain the model by using or adding a different loss function and see what happens to the performance of the segmentation model. The segmentation models losses can be combined together by ‘+’ and scaled by integer or float factor set class weights for dice_loss.
E.g., add in a <strong>categorical_crossentropy</strong> or <strong>CategoricalFocalLoss</strong> loss in the Configure the model for training section.</p></li>
</ol>
<blockquote>
<div><p>Hint: Further details for loss options can be found in <a class="reference external" href="https://segmentation-models.readthedocs.io/en/latest/api.html?highlight=loss#losses">segmentation losses</a></p>
</div></blockquote>
</section>
</section>
<section id="exercise-2-try-another-model-architecture">
<h1>Exercise 2: Try another model architecture<a class="headerlink" href="#exercise-2-try-another-model-architecture" title="Link to this heading">#</a></h1>
<p>Change the network architecture to U-net with Resnet backbone. Use pretrainded weights to initialize it.</p>
<blockquote>
<div><p>Hint: To do this, follow the instructions in <a class="reference external" href="https://segmentation-models.readthedocs.io/en/latest/tutorial.html?highlight=loss#simple-training-pipeline">Segmentation Models Python API</a>, and you can implete U-net with pretrained weights in simple two lines. It provides 4 models architectures for binary and multi class segmentation (including legendary Unet) and 25 available backbones for each architecture.  All backbones have pre-trained weights for faster and better convergence.</p>
</div></blockquote>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./book/3_ml4eo/3_sat_ml_deep"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloaders">Dataloaders</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualise-batch">Visualise Batch</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-model-u-net-based-model">Define the model: U-Net based model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-model">Segmentation Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">Training Loop</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualise-results">Visualise results</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-and-accuracy-functions">Loss and Accuracy Functions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-finetune-the-segmentation-model">Exercise 1: Finetune the segmentation model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-try-another-model-architecture">Exercise 2: Try another model architecture</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By SENSE CDT
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>